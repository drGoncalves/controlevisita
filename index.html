<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Check-In / Check-Out</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    #status { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üìç Registro de Localiza√ß√£o</h2>
  
  <input type="text" id="nome" placeholder="Seu nome"><br>
  <input type="text" id="cliente" placeholder="Cliente"><br>

  <button onclick="registrar('Check-in')">Check-in</button>
  <button onclick="registrar('Check-out')">Check-out</button>

  <p id="status">‚è≥ Aguardando a√ß√£o...</p>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyJfO4Mk5xWuHz3xx_V88LtJYoj6kjn0pP9rVdnoGv4b6nCHR-H0aagf8hfcRFOh8R3Tg/exec";

    function registrar(tipo) {
      document.getElementById("status").textContent = "üìç Obtendo localiza√ß√£o...";

      if (!navigator.geolocation) {
        document.getElementById("status").textContent = "‚ùå Geolocaliza√ß√£o n√£o suportada!";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          const nome = document.getElementById("nome").value || "Sem nome";
          const cliente = document.getElementById("cliente").value || "Sem cliente";

          document.getElementById("status").textContent = "‚è≥ Enviando dados...";

          // Cria o callback √∫nico para JSONP
          const callbackName = "cb_" + Date.now();
          window[callbackName] = function(response) {
            console.log("Resposta JSONP:", response);
            if (response.status === "success") {
              document.getElementById("status").textContent = "‚úÖ Registro salvo com sucesso!";
            } else {
              document.getElementById("status").textContent = "‚ö†Ô∏è Erro ao salvar.";
            }
            // Remove o script e callback ap√≥s execu√ß√£o
            delete window[callbackName];
            document.body.removeChild(script);
          };

          const url = `${WEBAPP_URL}?callback=${callbackName}&nome=${encodeURIComponent(nome)}&cliente=${encodeURIComponent(cliente)}&tipo=${encodeURIComponent(tipo)}&latitude=${lat}&longitude=${lon}`;

          const script = document.createElement("script");
          script.src = url;
          script.onerror = () => {
            document.getElementById("status").textContent = "‚ùå Falha na requisi√ß√£o!";
            delete window[callbackName];
            document.body.removeChild(script);
          };
          document.body.appendChild(script);
        },
        err => {
          document.getElementById("status").textContent = "‚ùå Erro ao obter localiza√ß√£o: " + err.message;
        },
        { timeout: 10000 } // Timeout de 10s
      );
    }
  </script>
</body>
</html>
